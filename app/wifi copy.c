#include <stdint.h>
#include <stdio.h>
#include "FreeRTOS.h"
#include "task.h"
#include "esp_at.h"
#include "page.h"
#include "wifi.h"

/* ============================================================================
 * 函数：wifi_init
 * 功能：初始化WiFi模块和相关服务
 * 说明：
 *   1. 初始化ESP-AT模块（ESP8266/ESP32的AT指令固件）
 *   2. 初始化WiFi功能
 *   3. 初始化SNTP时间同步服务
 *   如果任何步骤失败，显示错误页面并进入死循环
 * ============================================================================ */
void wifi_init(void)
{
    /* ------------------------------------------------------------------------
     * 第一步：初始化ESP-AT模块
     * 功能：
     *   - 配置串口通信（通常是USART2）
     *   - 发送AT测试指令验证模块响应
     *   - 设置AT指令模式
     * ------------------------------------------------------------------------ */
    if (!esp_at_init())
    {
        printf("[AT] init failed\n");
        goto err;  // 初始化失败，跳转到错误处理
    }
    printf("[AT] inited\n");
    
    /* ------------------------------------------------------------------------
     * 第二步：初始化WiFi功能
     * 功能：
     *   - 设置WiFi工作模式（通常是Station模式）
     *   - 配置WiFi参数
     *   - 准备WiFi连接环境
     * ------------------------------------------------------------------------ */
    if (!esp_at_wifi_init())
    {
        printf("[WIFI] init failed\n");
        goto err;  // 初始化失败，跳转到错误处理
    }
    printf("[WIFI] inited\n");
    
    /* ------------------------------------------------------------------------
     * 第三步：初始化SNTP（Simple Network Time Protocol）服务
     * 功能：
     *   - 配置NTP服务器地址（如pool.ntp.org）
     *   - 设置时区
     *   - 启用网络时间同步功能
     * SNTP用于从互联网获取准确的时间，同步到RTC芯片
     * ------------------------------------------------------------------------ */
    if (!esp_at_sntp_init())
    {
        printf("[SNTP] init failed\n");
        goto err;  // 初始化失败，跳转到错误处理
    }
    printf("[SNTP] inited\n");
    
    /* ------------------------------------------------------------------------
     * 所有初始化成功，正常返回
     * ------------------------------------------------------------------------ */
    return;
    
err:
    /* ------------------------------------------------------------------------
     * 错误处理：显示错误页面并挂起系统
     * 原因：WiFi是系统核心功能，如果初始化失败则无法继续运行
     * ------------------------------------------------------------------------ */
    error_page_display("wireless init failed");  // 在屏幕上显示错误信息
    while (1)
    {
        ;  // 死循环，系统挂起，等待用户重启设备
    }
}

/* ============================================================================
 * 函数：wifi_wait_connect
 * 功能：连接到WiFi并等待连接成功
 * 参数：无（使用wifi.h中定义的WIFI_SSID和WIFI_PASSWD宏）
 * 说明：
 *   - 发起WiFi连接请求
 *   - 轮询检查连接状态，最多等待10秒
 *   - 如果连接成功则返回，失败则显示错误页面并挂起
 * ============================================================================ */
void wifi_wait_connect(void)
{
    printf("[WIFI] connecting\n");
    
    /* ------------------------------------------------------------------------
     * 发起WiFi连接
     * 参数1：WiFi SSID（网络名称）- 在wifi.h中定义为"vivo X200 Pro mini"
     * 参数2：WiFi密码 - 在wifi.h中定义为"abc123456"
     * 参数3：BSSID（MAC地址）- NULL表示不指定，自动选择信号最强的AP
     * 
     * 注意：这是一个异步操作，函数立即返回，不等待连接完成
     * ------------------------------------------------------------------------ */
    esp_at_connect_wifi(WIFI_SSID, WIFI_PASSWD, NULL);
    
    /* ------------------------------------------------------------------------
     * 轮询等待WiFi连接成功
     * 最多等待10秒（10 * 1000ms），每100ms检查一次
     * ------------------------------------------------------------------------ */
    for (uint32_t t = 0; t < 10 * 1000; t += 100)
    {
        /* --------------------------------------------------------------------
         * 延时100ms
         * pdMS_TO_TICKS：将毫秒转换为FreeRTOS系统ticks
         * vTaskDelay：使当前任务进入阻塞状态，让出CPU给其他任务
         * -------------------------------------------------------------------- */
        vTaskDelay(pdMS_TO_TICKS(100));
        
        /* --------------------------------------------------------------------
         * 查询WiFi连接状态
         * -------------------------------------------------------------------- */
        esp_wifi_info_t wifi = { 0 };  // WiFi信息结构体
        
        /* ====================================================================
         * 检查连接状态
         * 条件1：esp_at_get_wifi_info(&wifi) - 成功获取WiFi信息
         * 条件2：wifi.connected - WiFi已连接
         * ==================================================================== */
        if (esp_at_get_wifi_info(&wifi) && wifi.connected)
        {
            /* ----------------------------------------------------------------
             * WiFi连接成功
             * ---------------------------------------------------------------- */
            printf("[WIFI] Connected\n");
            
            /* ----------------------------------------------------------------
             * 打印详细的WiFi连接信息
             * SSID：网络名称
             * BSSID：路由器MAC地址（格式：XX:XX:XX:XX:XX:XX）
             * Channel：WiFi信道（1-13，通常2.4GHz；36-165，通常5GHz）
             * RSSI：信号强度（单位：dBm，越接近0信号越强，如-30dBm > -70dBm）
             * ---------------------------------------------------------------- */
            printf("[WIFI] SSID: %s, BSSID: %s, Channel: %d, RSSI: %d\n",
                wifi.ssid, wifi.bssid, wifi.channel, wifi.rssi);
            
            /* ----------------------------------------------------------------
             * 连接成功，返回到调用者（main.c的main_init函数）
             * ---------------------------------------------------------------- */
            return;
        }
    }
    
    /* ------------------------------------------------------------------------
     * 超时处理：10秒内未连接成功
     * ------------------------------------------------------------------------ */
    printf("[WIFI] Connection Timeout\n");
    
    /* ------------------------------------------------------------------------
     * 显示错误页面并挂起系统
     * 原因：没有WiFi连接，无法获取天气数据和同步时间，系统无法正常工作
     * 用户需要：
     *   1. 检查WiFi SSID和密码是否正确（在wifi.h中配置）
     *   2. 检查路由器是否正常工作
     *   3. 检查WiFi模块硬件连接
     *   4. 重启设备重试
     * ------------------------------------------------------------------------ */
    error_page_display("wireless connect failed");  // 在屏幕上显示错误信息
    while (1)
    {
        ;  // 死循环，系统挂起，等待用户重启设备
    }
}

